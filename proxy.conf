# Real IP configuration
real_ip_header X-Forwarded-For;
set_real_ip_from 127.0.0.1;
set_real_ip_from 10.0.0.0/8;
set_real_ip_from 172.16.0.0/12;
set_real_ip_from 192.168.0.0/16;

# Buffer sizes for large headers
large_client_header_buffers 4 32k;
client_header_buffer_size 8k;
client_max_body_size 50M;

# Main location block
location / {
    # Basic proxy settings
    proxy_pass http://127.0.0.1:5002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Forward all original headers
    proxy_pass_request_headers on;

    # Client Hints headers (for hardware/performance data)
    proxy_set_header Sec-CH-UA $http_sec_ch_ua;
    proxy_set_header Sec-CH-UA-Mobile $http_sec_ch_ua_mobile;
    proxy_set_header Sec-CH-UA-Platform $http_sec_ch_ua_platform;
    proxy_set_header Sec-CH-UA-Platform-Version $http_sec_ch_ua_platform_version;
    proxy_set_header Sec-CH-UA-Arch $http_sec_ch_ua_arch;
    proxy_set_header Sec-CH-UA-Bitness $http_sec_ch_ua_bitness;
    proxy_set_header Sec-CH-UA-WoW64 $http_sec_ch_ua_wow64;
    proxy_set_header Sec-CH-Device-Memory $http_sec_ch_device_memory;
    proxy_set_header Sec-CH-DPR $http_sec_ch_dpr;
    proxy_set_header Sec-CH-Viewport-Width $http_sec_ch_viewport_width;
    proxy_set_header Sec-CH-Viewport-Height $http_sec_ch_viewport_height;

    # Network performance hints
    proxy_set_header Sec-CH-Downlink $http_sec_ch_downlink;
    proxy_set_header Sec-CH-RTT $http_sec_ch_rtt;
    proxy_set_header Sec-CH-ECT $http_sec_ch_ect;
    proxy_set_header Sec-CH-Save-Data $http_sec_ch_save_data;

    # User preference hints
    proxy_set_header Sec-CH-Prefers-Color-Scheme $http_sec_ch_prefers_color_scheme;
    proxy_set_header Sec-CH-Prefers-Reduced-Motion $http_sec_ch_prefers_reduced_motion;

    # Security/fetch headers
    proxy_set_header Sec-Fetch-Site $http_sec_fetch_site;
    proxy_set_header Sec-Fetch-Mode $http_sec_fetch_mode;
    proxy_set_header Sec-Fetch-User $http_sec_fetch_user;
    proxy_set_header Sec-Fetch-Dest $http_sec_fetch_dest;

    # Standard headers
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Accept $http_accept;
    proxy_set_header Accept-Language $http_accept_language;
    proxy_set_header Accept-Encoding $http_accept_encoding;
    proxy_set_header DNT $http_dnt;
    proxy_set_header Connection $http_connection;
    proxy_set_header Referer $http_referer;

    # CloudFlare headers (if using CF)
    proxy_set_header CF-Ray $http_cf_ray;
    proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
    proxy_set_header CF-IPCountry $http_cf_ipcountry;

    # Cookie forwarding
    proxy_set_header Cookie $http_cookie;

    # Content type for POST requests
    proxy_set_header Content-Type $content_type;
    proxy_set_header Content-Length $content_length;

    # Disable proxy buffering for real-time data
    proxy_buffering off;
    proxy_request_buffering off;

    # Timeout settings
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Security headers for advanced data collection
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Enable Client Hints
    add_header Accept-CH "Sec-CH-UA, Sec-CH-UA-Mobile, Sec-CH-UA-Platform, Sec-CH-UA-Platform-Version, Sec-CH-UA-Arch, Sec-CH-UA-Bitness, Sec-CH-Device-Memory, Sec-CH-DPR, Sec-CH-Viewport-Width, Sec-CH-Viewport-Height, Sec-CH-Downlink, Sec-CH-RTT, Sec-CH-ECT, Sec-CH-Save-Data, Sec-CH-Prefers-Color-Scheme, Sec-CH-Prefers-Reduced-Motion" always;
    add_header Critical-CH "Sec-CH-UA-Platform, Sec-CH-Device-Memory" always;
}

# Specific API endpoint handling
location /api/collect-advanced-data {
    proxy_pass http://127.0.0.1:5002;
    proxy_method POST;

    # Ensure all headers are forwarded for API calls
    proxy_pass_request_headers on;
    proxy_pass_request_body on;

    # Set headers to preserve original request info
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Content handling
    proxy_set_header Content-Type $content_type;
    proxy_set_header Content-Length $content_length;

    # Forward all security and client hint headers
    proxy_set_header Sec-CH-UA $http_sec_ch_ua;
    proxy_set_header Sec-CH-UA-Mobile $http_sec_ch_ua_mobile;
    proxy_set_header Sec-CH-UA-Platform $http_sec_ch_ua_platform;
    proxy_set_header Sec-CH-Device-Memory $http_sec_ch_device_memory;
    proxy_set_header Sec-CH-DPR $http_sec_ch_dpr;
    proxy_set_header Sec-CH-Viewport-Width $http_sec_ch_viewport_width;
    proxy_set_header Sec-CH-Viewport-Height $http_sec_ch_viewport_height;

    # Disable buffering for API responses
    proxy_buffering off;
    proxy_request_buffering off;

    # CORS headers for API
    add_header Access-Control-Allow-Origin "$http_origin" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials "true" always;
}

# Static files handling
location /static/ {
    proxy_pass http://127.0.0.1:5002;
    proxy_set_header Host $host;

    # Cache static files
    proxy_cache_valid 200 1h;
    add_header Cache-Control "public, max-age=3600" always;
}

# Handle preflight requests
location ~ ^/api/ {
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "$http_origin" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}